<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–ï–° 1 - QR CLOUD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #00ffcc; --panel: #111411; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: #eee; }
        
        #main-wrapper { display: flex; width: 100vw; height: 100vh; }
        #forest { flex: 1; position: relative; overflow: hidden; background: #050505; }
        
        #bg-container { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1; }
        #bg-media { width: 100%; height: 100%; object-fit: cover; }
        
        #hero-layer { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        .hero { position: absolute; transform-origin: center bottom; bottom: 0; will-change: transform; }

        /* –ü–∞–Ω–µ–ª—å */
        #side-panel { width: 350px; background: var(--panel); border-left: 1px solid #333; display: flex; flex-direction: column; z-index: 100; transition: 0.4s; }
        #side-panel.hidden { margin-right: -350px; }
        #toggle-btn { position: absolute; left: -40px; top: 20px; width: 40px; height: 40px; background: var(--panel); color: var(--accent); border: 1px solid #333; cursor: pointer; border-radius: 5px 0 0 5px; }

        .content { padding: 15px; overflow-y: auto; flex: 1; }
        .group { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; }
        .group-title { font-size: 10px; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; font-weight: bold; }
        
        #journal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .journal-item { width: 100%; aspect-ratio: 1; background: #000; border: 1px solid #444; border-radius: 6px; cursor: pointer; object-fit: contain; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ QR */
        #qr-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #qr-code { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¢–µ–ª–µ—Ñ–æ–Ω–∞ */
        #phone-view { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .phone-btn { width: 250px; height: 250px; border: 4px dashed var(--accent); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }

        button { width: 100%; padding: 12px; background: #2a2d26; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .btn-main { background: var(--accent) !important; color: #000 !important; }
    </style>
</head>
<body>

<div id="main-wrapper">
    <div id="forest">
        <div id="bg-container"><img id="bg-media" src="https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=1920"></div>
        <div id="hero-layer"></div>
    </div>

    <div id="side-panel">
        <button id="toggle-btn" onclick="$('side-panel').classList.toggle('hidden')">‚óÄ</button>
        <div class="content">
            <div class="group">
                <div class="group-title">üîë –°–ò–°–¢–ï–ú–ê –û–ë–õ–ê–ö–ê</div>
                <input type="password" id="api-key" placeholder="–í—Å—Ç–∞–≤—å API Imgbb" style="width:100%; padding:10px; background:#000; border:1px solid #444; color:white; margin-bottom:10px;">
                <button class="btn-main" onclick="openQR()">üì≤ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –ü–£–õ–¨–¢ (QR)</button>
            </div>

            <div class="group">
                <div class="group-title">üì¶ –ñ–£–†–ù–ê–õ –ó–ê–ì–†–£–ó–û–ö</div>
                <div id="journal-grid"></div>
            </div>

            <div class="group">
                <div class="group-title">üë• –í –õ–ï–°–£</div>
                <div id="hero-active-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="qr-modal" onclick="this.style.display='none'">
    <div id="qr-code"></div>
    <p style="color:white; font-weight:bold;">–û–¢–°–ö–ê–ù–ï–†–£–ô–¢–ï –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –ì–ï–†–û–Ø</p>
    <p style="color:#666; font-size:12px; margin-top:10px;">(–∫–ª–∏–∫–Ω–∏—Ç–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å)</p>
</div>

<div id="phone-view">
    <div class="phone-btn" onclick="$('file-up').click()">
        <span style="font-size:60px">üì∏</span>
        <p style="margin-top:15px; font-weight:bold; color:var(--accent)">–û–¢–ü–†–ê–í–ò–¢–¨ –í –õ–ï–°</p>
    </div>
    <input type="file" id="file-up" hidden accept="image/*" onchange="uploadPhoto(this)">
    <div id="upload-status" style="margin-top:30px; color:white; text-align:center;"></div>
</div>

<script>
    const $ = id => document.getElementById(id);
    let heroes = [];

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ (–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ü—Ä–æ–µ–∫—Ç–æ—Ä)
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        
        if (key) {
            // –ï—Å–ª–∏ –≤ —Å—Å—ã–ª–∫–µ –µ—Å—Ç—å –∫–ª—é—á ‚Äî –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            $('phone-view').style.display = 'flex';
            $('api-key').value = key;
        }
        update();
    };

    // 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
    function openQR() {
        const key = $('api-key').value;
        if (!key) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ API –ö–ª—é—á Imgbb!");
        
        const baseUrl = window.location.href.split('?')[0];
        const fullUrl = `${baseUrl}?key=${key}`;
        
        $('qr-code').innerHTML = ""; // –û—á–∏—Å—Ç–∫–∞
        new QRCode($('qr-code'), {
            text: fullUrl,
            width: 250,
            height: 250
        });
        
        $('qr-modal').style.display = 'flex';
    }

    // 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (–¢–µ–ª–µ—Ñ–æ–Ω)
    async function uploadPhoto(input) {
        const key = $('api-key').value;
        if (!input.files[0]) return;

        $('upload-status').innerHTML = "‚è≥ –û–¢–ü–†–ê–í–ö–ê –ì–ï–†–û–Ø... <br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É";
        
        const fd = new FormData();
        fd.append('image', input.files[0]);

        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${key}`, {
                method: 'POST',
                body: fd
            });
            const data = await res.json();
            
            if(data.success) {
                $('upload-status').innerHTML = "‚úÖ –ì–ï–†–û–ô –î–û–°–¢–ê–í–õ–ï–ù!<br>–û–Ω –ø–æ—è–≤–∏–ª—Å—è –≤ –∂—É—Ä–Ω–∞–ª–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.";
                // –ï—Å–ª–∏ –º—ã –Ω–∞ —Ç–æ–º –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (–¥–ª—è —Ç–µ—Å—Ç–∞) - –¥–æ–±–∞–≤–∏–º –≤ –∂—É—Ä–Ω–∞–ª —Å—Ä–∞–∑—É
                addToJournal(data.data.url);
            } else {
                $('upload-status').innerHTML = "‚ùå –û–®–ò–ë–ö–ê –û–ë–õ–ê–ö–ê";
            }
        } catch (e) {
            $('upload-status').innerHTML = "‚ùå –û–®–ò–ë–ö–ê –°–ï–¢–ò";
        }
    }

    // 4. –†–∞–±–æ—Ç–∞ —Å –ª–µ—Å–æ–º (–ü—Ä–æ–µ–∫—Ç–æ—Ä)
    function addToJournal(src) {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'journal-item';
        img.onclick = () => addHeroToForest(src);
        $('journal-grid').prepend(img);
    }

    function addHeroToForest(src) {
        const id = Date.now();
        const img = document.createElement('img');
        img.src = src; img.className = 'hero'; img.id = 'h-' + id;
        
        const isFar = heroes.length % 2 === 0;
        img.style.bottom = isFar ? "45%" : "5%";
        img.style.width = isFar ? "180px" : "320px";
        img.style.zIndex = isFar ? 5 : 20;
        
        $('hero-layer').appendChild(img);
        heroes.push({id, el: img, x: -400, speed: 1.5 + Math.random(), angle: Math.random()*10});
        
        const item = document.createElement('div');
        item.id = 'ctrl-' + id;
        item.className = 'group';
        item.style = "display:flex; align-items:center; gap:10px; margin-bottom:5px;";
        item.innerHTML = `
            <img src="${src}" style="width:30px;height:30px;object-fit:cover;">
            <input type="range" min="50" max="800" value="${isFar?180:320}" oninput="$('h-${id}').style.width = this.value+'px'">
            <button onclick="removeHero(${id})" style="width:30px; background:#500">√ó</button>
        `;
        $('hero-active-list').appendChild(item);
    }

    function removeHero(id) {
        const h = heroes.find(x => x.id === id);
        if(h) { h.el.remove(); $(`ctrl-${id}`).remove(); heroes = heroes.filter(x => x.id !== id); }
    }

    function update() {
        const w = $('forest').clientWidth;
        heroes.forEach(h => {
            h.x += h.speed; h.angle += 0.05;
            if(h.x > w + 500) h.x = -500;
            h.el.style.transform = `translateX(${h.x}px) translateY(${Math.sin(h.angle)*5}px)`;
        });
        requestAnimationFrame(update);
    }
</script>
</body>
</html>
