<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ê–ó–ê 3.0 - –õ–ï–° 1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #00ffcc; --panel: #111411; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: #eee; }
        
        /* –≠–∫—Ä–∞–Ω –ª–µ—Å–∞ */
        #forest { width: 100vw; height: 100vh; position: relative; overflow: hidden; background: #050505; }
        #bg-container { position: absolute; inset: 0; z-index: 1; }
        #bg-media { width: 100%; height: 100%; object-fit: cover; }
        #hero-layer { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        .hero { position: absolute; transform-origin: center bottom; bottom: 0; transition: width 0.3s; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–°–∫—Ä—ã—Ç–∞—è) */
        #side-panel { 
            position: fixed; right: 0; top: 0; width: 320px; height: 100%; 
            background: var(--panel); border-left: 1px solid #333; z-index: 100;
            transform: translateX(100%); transition: 0.4s; padding: 20px;
        }
        #side-panel.open { transform: translateX(0); }
        #panel-trigger { 
            position: absolute; left: -40px; top: 20px; width: 40px; height: 40px; 
            background: var(--panel); color: var(--accent); border: 1px solid #333; cursor: pointer;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        .group { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .group-title { font-size: 10px; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; font-weight: bold; }
        input { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; margin-bottom: 10px; border-radius: 5px; font-size: 12px; }
        button { width: 100%; padding: 12px; background: var(--accent); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        #journal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .journal-item { width: 100%; aspect-ratio: 1; background: #222; border-radius: 5px; object-fit: contain; cursor: pointer; border: 1px solid #444; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        #qr-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #qr-code { background: white; padding: 15px; border-radius: 10px; }

        /* –¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º */
        #phone-view { position: fixed; inset: 0; background: #111; z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .big-upload { width: 220px; height: 220px; border: 4px dashed var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; }
    </style>
</head>
<body>

<div id="forest">
    <div id="bg-container"><img id="bg-media" src="https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=1920"></div>
    <div id="hero-layer"></div>
</div>

<div id="side-panel">
    <button id="panel-trigger" onclick="$('side-panel').classList.toggle('open')">‚óÄ</button>
    <div class="group">
        <div class="group-title">üîë –ö–õ–Æ–ß–ò –î–û–°–¢–£–ü–ê</div>
        <input type="password" id="key-cloud" placeholder="Imgbb API Key">
        <input type="password" id="key-ai" placeholder="Remove.bg API Key (–¥–ª—è –ò–ò)">
        <button onclick="generateQR()">üì≤ –°–û–ó–î–ê–¢–¨ QR –î–õ–Ø –ü–£–õ–¨–¢–ê</button>
    </div>
    
    <div class="group">
        <div class="group-title">üìú –ñ–£–†–ù–ê–õ –ò–ò (–û–ë–ù–û–í–õ–ï–ù–ò–ï 10–°)</div>
        <div id="journal-grid"></div>
    </div>

    <div id="active-list"></div>
</div>

<div id="qr-modal" onclick="this.style.display='none'">
    <div id="qr-code"></div>
    <p style="margin-top:20px; font-weight:bold">–°–ö–ê–ù –ö –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Æ –ü–£–õ–¨–¢–ê</p>
</div>

<div id="phone-view">
    <div class="big-upload" onclick="$('file-in').click()">
        <span style="font-size:50px">üì∑</span>
        <p style="color:var(--accent); font-weight:bold; margin-top:10px">–í–´–ë–†–ê–¢–¨ –ì–ï–†–û–Ø</p>
    </div>
    <input type="file" id="file-in" hidden accept="image/*" onchange="mobileUpload(this)">
    <div id="phone-status" style="margin-top:30px; text-align:center; padding:0 20px;"></div>
</div>

<script>
    const $ = id => document.getElementById(id);
    let heroes = [], knownUrls = new Set();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if(params.get('k_c')) {
            $('phone-view').style.display = 'flex';
            $('key-cloud').value = params.get('k_c');
            $('key-ai').value = params.get('k_a');
        } else {
            // –ï—Å–ª–∏ –º—ã –Ω–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä–µ, –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–ª–∞–∫–∞
            setInterval(checkCloudJournal, 10000);
        }
        update();
    };

    function generateQR() {
        const kc = $('key-cloud').value;
        const ka = $('key-ai').value;
        if(!kc) return alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –∫–ª—é—á Imgbb");
        
        const url = `${window.location.href.split('?')[0]}?k_c=${kc}&k_a=${ka}`;
        $('qr-code').innerHTML = "";
        new QRCode($('qr-code'), { text: url, width: 250, height: 250 });
        $('qr-modal').style.display = 'flex';
    }

    // –¢–ï–õ–ï–§–û–ù: –ó–∞–≥—Ä—É–∑–∫–∞ + –ò–ò
    async function mobileUpload(input) {
        if(!input.files[0]) return;
        const kc = $('key-cloud').value;
        const ka = $('key-ai').value;
        const status = $('phone-status');

        status.innerHTML = "‚è≥ –ó–ê–ì–†–£–ó–ö–ê...";
        
        try {
            // 1. –°–Ω–∞—á–∞–ª–∞ –≤—ã—Ä–µ–∑–∞–µ–º —Ñ–æ–Ω —á–µ—Ä–µ–∑ –ò–ò (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á)
            let imageToUpload = input.files[0];
            
            if(ka) {
                status.innerHTML = "‚úÇÔ∏è –ò–ò –í–´–†–ï–ó–ê–ï–¢ –§–û–ù...";
                const aiData = new FormData();
                aiData.append('image_file', input.files[0]);
                const aiRes = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: { 'X-Api-Key': ka },
                    body: aiData
                });
                if(aiRes.ok) imageToUpload = await aiRes.blob();
            }

            // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–±–ª–∞–∫–æ Imgbb
            status.innerHTML = "‚òÅÔ∏è –û–¢–ü–†–ê–í–ö–ê –í –û–ë–õ–ê–ö–û...";
            const cloudData = new FormData();
            cloudData.append('image', imageToUpload);
            const cloudRes = await fetch(`https://api.imgbb.com/1/upload?key=${kc}`, {
                method: 'POST',
                body: cloudData
            });
            const cloudJson = await cloudRes.json();
            
            if(cloudJson.success) {
                status.innerHTML = "‚úÖ –ì–û–¢–û–í–û! –ì–ï–†–û–ô –í –õ–ï–°–£";
                setTimeout(() => status.innerHTML = "", 3000);
            }
        } catch(e) { status.innerHTML = "‚ùå –û–®–ò–ë–ö–ê"; }
    }

    // –ü–ö: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ (–∏–º–∏—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ API Imgbb —Å–ª–æ–∂–Ω–∞ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏, 
    // –ø–æ—ç—Ç–æ–º—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –∑–∞ 10 —Å–µ–∫ 
    // –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ API –ø–æ–∏—Å–∫–∞, 
    // –Ω–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ - —ç—Ç–æ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å)
    
    function checkCloudJournal() {
        // –í —á–∏—Å—Ç–æ–º JS –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ –º—ã –Ω–µ –º–æ–∂–µ–º "–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å" —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ Imgbb.
        // –ü–æ—ç—Ç–æ–º—É –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã "–ø–∞–ø–∫–∏" –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Firebase.
        // –ù–æ —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π —Å—Ç–µ–∫, –º—ã –ø—Ä–æ—Å—Ç–æ —Å–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏.
        console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∂—É—Ä–Ω–∞–ª–∞...");
    }

    function addToJournal(src) {
        if(knownUrls.has(src)) return;
        knownUrls.add(src);
        const img = document.createElement('img');
        img.src = src; img.className = 'journal-item';
        img.onclick = () => spawnHero(src);
        $('journal-grid').prepend(img);
    }

    function spawnHero(src) {
        const id = Date.now();
        const img = document.createElement('img');
        img.src = src; img.className = 'hero'; img.id = 'h-'+id;
        img.style.width = "250px";
        $('hero-layer').appendChild(img);
        heroes.push({id, el:img, x:-300, speed: 1.5+Math.random(), angle:0});
        
        const ctrl = document.createElement('div');
        ctrl.id = 'c-'+id;
        ctrl.className = 'group';
        ctrl.innerHTML = `<input type="range" min="50" max="800" value="250" oninput="$('h-${id}').style.width=this.value+'px'"><button onclick="removeHero(${id})">–£–î–ê–õ–ò–¢–¨</button>`;
        $('active-list').appendChild(ctrl);
    }

    function removeHero(id) {
        const h = heroes.find(x => x.id === id);
        if(h) { h.el.remove(); $(`c-${id}`).remove(); heroes = heroes.filter(x => x.id !== id); }
    }

    function update() {
        const w = window.innerWidth;
        heroes.forEach(h => {
            h.x += h.speed; h.angle += 0.05;
            if(h.x > w + 400) h.x = -400;
            h.el.style.transform = `translateX(${h.x}px) translateY(${Math.sin(h.angle)*5}px)`;
        });
        requestAnimationFrame(update);
    }
</script>
</body>
</html>
